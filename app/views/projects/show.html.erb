<h2><%= @project.name %></h2>
<h3><%= @project.target_folders %></h3>

<% if @project.commits.size > 0 %>
  <ul class='scores'>
    <li><%= @project.current_score(:rbp)%> <span>problems</span></li>
    <li><%= @project.current_score(:flog)%> <span>complexity</span></li>
  </ul>
<% end %>

<%= button_to 'Update', import_commits_project_path, :method => :put, :disable_with => 'Updating...'%>


<script type="text/javascript">
  $(function () {
    var flog = [<%=@commits.reverse.map {|t| "[#{t.build_number},#{t.flog}]"}.join(',')%>];
    var rbp = [<%=@commits.reverse.map {|t| "[#{t.build_number},#{t.rbp}]"}.join(',')%>];
    $.plot($("#graph"), 
      [{data:rbp,label:'Rails Bad Practices',yaxis:2},{data:flog,label:'Flog'}], {
        series: {
          lines: { show: true },
          points: { show: true }
        },
        legend: { position: 'nw' },
        grid: { hoverable: true, clickable: true }
      }
    );
    
    var previousPoint;
    
    $("#graph").bind("plothover", function (event, pos, item) {
      if (item) {
        if (previousPoint != item.datapoint) {
          previousPoint = item.datapoint;
          $("#tooltip").remove();
          var x = item.datapoint[0];
          var y = item.datapoint[1].toFixed(2);
          showTooltip(item.pageX, item.pageY," build #" + x + ": " + y);
        }
      }
      else {
        $("#tooltip").remove();
        previousPoint = null;            
      }
    });
    
    $("#graph").bind("plotclick", function (event, pos, item) {
      if (item) {
        window.location = '<%= @project.ci_server_url%>' + item.datapoint[0]
      }
    });

    
    function showTooltip(x,y,text) {
      $('<div id="tooltip">' + text + '</div>').css( {
          position: 'absolute',
          top: y + 5,
          left: x + 5,
          border: '1px solid #fdd',
          padding: '2px',
          'background-color': '#fee',
          opacity: 0.80
      }).appendTo("body");
    }
    
    
  });
  
</script>

<div id="graph" style='height:300px'>
  
</div>

<%= will_paginate @commits %>

<%= form_commit(@project, :method => :get) do %>
  <%= text_field_commit :comment %>
  <%= submit_commit "Search" %>
<% end %>

<table class='stats'>
  <tr>
    <th>Tag</th>
    <th>Comment</th>
    <th colspan="2">RBP</th>
    <th colspan="2">Flog</th>
  </tr>
  <% @commits.each do |commit|%>
  <tr class='<%= commit.assessment%>'>
    <td><%= link_to commit.name, commit_url(commit), :target => 'blank'%></td>
    <td><%= link_to (commit.comment || '-'), [:edit, @project, commit]%></td>
    <td><%= commit.rbp%></td>
    <td class='number'><%= change_indicator(commit, :rbp)%></td>
    <td><%= commit.flog%></td>
    <td class='number'><%= change_indicator(commit, :flog)%></td>
  </tr>
  <% end %>
</table>

<%= will_paginate @commits %>

<%= link_to 'Edit', edit_project_path(@project) %>